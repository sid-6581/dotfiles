#!/usr/bin/env nu

# Relaunch using Windows nushell if started from WSL.
if $nu.os-info.name == "linux" {
  let nu_exe = $"($env.HOME)/winhome/.local/bin/nu.exe"
  ^$nu_exe $env.CURRENT_FILE
  exit
}

source config/.config/nushell/env.nu

use config/.config/nushell/scripts/log.nu

let log_file = log update-file

# Run everything from the Windows home directory, since some tools don't like being run from the WSL UNC path.
cd $env.HOME

log info "Updating Windows"

do {
  log info "Updating scoop" --file $log_file
  ^scoop update
  ^scoop update -s '*'
  ^scoop cleanup '*'
  ^scoop cache rm '*'

  log info "Updating rustup" --file $log_file
  ^rustup update

  log info "Updating cargo" --file $log_file
  ^cargo install-update -a

  log info "Updating tldr" --file $log_file
  ^tldr -u

  log info "Updating nvim" --file $log_file
  ^nvim --headless "+Lazy! sync" "+qa"
  ^nvim --headless "+MasonToolsUpdateSync" "+qa"
  ^nvim --headless "+TSUpdateSync" "+qa"
} o+e>> $log_file

^sudo nu $"($env.FILE_PWD)/update-windows-sudo.nu"

exit
